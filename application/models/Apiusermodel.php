<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Apiusermodel extends CI_Model {    function __construct()    {        parent::__construct();    }
//#################### Email ####################//	function sendMail($to,$subject,$email_message)	{		// Set content-type header for sending HTML email		$headers = "MIME-Version: 1.0" . "\r\n";		$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";		// Additional headers		$headers .= 'From: ENSYFI<admin@spv.com>' . "\r\n";		mail($to,$subject,$email_message,$headers);	}//#################### Email End ####################////#################### SMS ####################//	function sendSMS($user_mobile,$mobile_message)	{        //Your authentication key          $authKey = "191431AStibz285a4f14b4";          //Multiple mobiles numbers separated by comma          $mobile = "$user_mobile";          //Sender ID,While using route4 sender id should be 6 characters long.          $senderId = "SPVAPP";          //Your message to send, Add URL encoding here.          $message = $mobile_message;          //Define route          $route = "transactional";          //Prepare you post parameters          $postData = array(              'authkey' => $authKey,              'mobiles' => $mobile,              'message' => $message,              'sender' => $senderId,              'route' => $route          );          //API URL          $url="https://control.msg91.com/api/sendhttp.php";          // init the resource          $ch = curl_init();          curl_setopt_array($ch, array(              CURLOPT_URL => $url,              CURLOPT_RETURNTRANSFER => true,              CURLOPT_POST => true,              CURLOPT_POSTFIELDS => $postData              //,CURLOPT_FOLLOWLOCATION => true          ));          //Ignore SSL certificate verification          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);          //get response          $output = curl_exec($ch);          //Print error if any          if(curl_errno($ch))          {              echo 'error:' . curl_error($ch);          }          curl_close($ch);	}//#################### SMS End ####################////#################### Notification ####################//	function sendNotification($gcm_key,$Title,$Message,$mobiletype)	{		if ($mobiletype =='1'){		    require_once 'assets/notification/Firebase.php';            require_once 'assets/notification/Push.php';            $device_token = explode(",", $gcm_key);            $push = null;//        //first check if the push has an image with it		    $push = new Push(					$Title,					$Message,					'http://heylaapp.com/assets/notification/images/events.jpg'				);// 			//if the push don't have an image give null in place of image 			// $push = new Push( 			// 		'HEYLA', 			// 		'Hi Testing from maran', 			// 		null 			// 	);    		//getting the push from push object    		$mPushNotification = $push->getPush();    		//creating firebase class object    		$firebase = new Firebase();    	foreach($device_token as $token) {    		 $firebase->send(array($token),$mPushNotification);    	}		} else {			$device_token = explode(",", $gcm_key);			$passphrase = 'hs123';		    $loction ='assets/notification/heylaapp.pem';			$ctx = stream_context_create();			stream_context_set_option($ctx, 'ssl', 'local_cert', $loction);			stream_context_set_option($ctx, 'ssl', 'passphrase', $passphrase);			// Open a connection to the APNS server			$fp = stream_socket_client('ssl://gateway.sandbox.push.apple.com:2195', $err, $errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);			if (!$fp)				exit("Failed to connect: $err $errstr" . PHP_EOL);			$body['aps'] = array(				'alert' => array(					'body' => $Message,					'action-loc-key' => 'Heyla App',				),				'badge' => 2,				'sound' => 'assets/notification/oven.caf',				);			$payload = json_encode($body);			foreach($device_token as $token) {				// Build the binary notification    			$msg = chr(0) . pack("n", 32) . pack("H*", str_replace(" ", "", $token)) . pack("n", strlen($payload)) . $payload;        		$result = fwrite($fp, $msg, strlen($msg));			}				fclose($fp);		}	}//#################### Notification End ####################////#################### Generate otp ####################//
	public function Generate_otp($mobile_number)	{		$digits = 6;		$OTP = str_pad(rand(0, pow(10, $digits)-1), $digits, '0', STR_PAD_LEFT);					$sql = "SELECT * FROM user_master WHERE phone_number='$mobile_number'";		$user_result = $this->db->query($sql);		if($user_result->num_rows()>0)		{			$update_sql = "UPDATE user_master SET otp = '$OTP' WHERE phone_number  ='$mobile_number'";    		$update_otp = $this->db->query($update_sql);			$mobile_message = 'Dear user, Use the OTP '.$OTP.' to login.- Team SPVAPP';			//$this->sendSMS($mobile_number,$mobile_message);		} else {			$sQuery = "INSERT INTO user_master (phone_number,otp,language_id,subscription,notification,status,created_at) VALUES ('".$mobile_number. "','".$OTP. "','1','1','1','Active',now())";			$insert_user = $this->db->query($sQuery);			$user_id = $this->db->insert_id();			$mobile_message = 'Dear user, Use the OTP '.$OTP.' to login.- Team SPVAPP';			//$this->sendSMS($mobile_number,$mobile_message);		}				$response = array("status" => "Success", "msg" => "OTP Generated", "mobile_number" => $mobile_number,"otp" => $OTP);		return $response;	}
//#################### Generate otp End ####################////#################### Resend otp ####################//	public function Resend_otp($mobile_number)	{		$userQuery = "SELECT * FROM user_master WHERE phone_number='$mobile_number'";		$user_result = $this->db->query($userQuery);		if($user_result->num_rows()>0)		{			foreach ($user_result->result() as $rows)			{				$OTP = $rows->otp;			}						$mobile_message = 'Dear user, Use the OTP '.$OTP.' to login.- Team SPVAPP';			//$this->sendSMS($mobile_number,$mobile_message);						$response = array("status" => "Success", "msg" => "Resend OTP", "mobile_number" => $mobile_number,"otp" => $OTP);		} else {			$response = array("status" => "Error", "msg" => "Mobile number Error");		}				return $response;	}//#################### Resend otp End ####################//
//#################### Login ####################//	public function Login($mobile_number,$otp,$device_token,$device_type)	{		$userQuery = "SELECT * FROM user_master WHERE phone_number='$mobile_number' AND otp = $otp AND status = 'Active'";		$user_result = $this->db->query($userQuery);		if($user_result->num_rows()>0)		{			foreach ($user_result->result() as $rows)			{				$user_id = $rows->id;				$full_name  = $rows->full_name ;				$phone_number = $rows->phone_number;				$email_id = $rows->email_id;				$gender = $rows->gender;				$dob = $rows->dob;				$profile_pic = $rows->profile_pic;				$language_id = $rows->language_id;				$subscription = $rows->subscription;				$notification = $rows->notification;				$status = $rows->status;			}			if ($profile_pic != ''){			    $picture_url = base_url().'assets/users/'.$profile_pic;			}else {				$picture_url = '';			}						$userData  = array(							"user_id" => $user_id,							"full_name" => $full_name,							"phone_number" => $phone_number,							"language_id" => $language_id,							"profile_pic" => $picture_url						);							$gcmQuery = "SELECT * FROM notification_master WHERE device_token like '%" .$device_token. "%' LIMIT 1";			$gcm_result = $this->db->query($gcmQuery);			if($gcm_result->num_rows()==0)			{				$sQuery = "INSERT INTO notification_master (user_master_id,device_type,device_token,created_at) VALUES ('". $user_id . "','". $device_type . "','". $device_token . "',now())";				$update_gcm = $this->db->query($sQuery);			}							$response = array("status" => "Success", "msg" => "Login Successfully", "userData" => $userData);		} else {			$response = array("status" => "Error", "msg" => "Account Deactivated");		}		return $response;	}//#################### Login End ####################////#################### Profile update ####################//	public function Profile_update($user_id,$full_name,$phone_number,$email_id,$gender,$dob)	{		$update_sql= "UPDATE user_master SET full_name ='$full_name',phone_number ='$phone_number',email_id ='$email_id',gender ='$gender',dob ='$dob',updated_by='$user_id',updated_at=now() WHERE id='$user_id'";		$update_result = $this->db->query($update_sql);				$response = array("status" => "Success", "msg" => "Profile Updated");		return $response;	}//#################### Profile_update End ####################////#################### Profile Pic Update ####################//	public function Profilepic_update($user_id,$userFileName)	{            $update_sql= "UPDATE user_master SET profile_pic='$userFileName' WHERE id='$user_id'";			$update_result = $this->db->query($update_sql);			$picture_url = base_url().'assets/users/'.$userFileName;			$response = array("status" => "success", "msg" => "Profile Picture Updated","picture_url" =>$picture_url);			return $response;	}//#################### Profile Pic Update End ####################////#################### Profile details ####################//	function Profile_details($user_id)	{		$query = "SELECT * FROM `user_master` WHERE id = '$user_id'";		$resultset = $this->db->query($query);		$user_result = $resultset->result();		if($resultset->num_rows()>0)			{				$response = array("status" => "Success", "msg" => "User Details", "user_details" =>$user_result);			} else {				$response = array("status" => "Error", "msg" => "No records found");			}		return $response;	}//#################### Profile details end ####################////#################### List language ####################//	function List_language($user_id)	{		$query = "SELECT * FROM `language_type_master` WHERE status = 'Active'";		$resultset = $this->db->query($query);		$lang_result = $resultset->result();		if($resultset->num_rows()>0)			{				$response = array("status" => "Success", "msg" => "Language Details", "lang_details" =>$lang_result);			} else {				$response = array("status" => "Error", "msg" => "No records found");			}		return $response;	}//#################### List language  ####################////#################### Language update ####################//	public function Language_update($user_id,$language_id)	{		$update_sql= "UPDATE user_master SET language_id ='$language_id' WHERE id='$user_id'";		$update_result = $this->db->query($update_sql);				$response = array("status" => "Success", "msg" => "Language Updated","language_id" =>$language_id);		return $response;	}//#################### Language update End ####################////#################### Subscription update ####################//	public function Subscription_update($user_id,$status)	{		$update_sql= "UPDATE user_master SET subscription ='$status' WHERE id='$user_id'";		$update_result = $this->db->query($update_sql);				$response = array("status" => "Success", "msg" => "Subscription Updated");		return $response;	}//#################### Subscription update End ####################////#################### Notification update ####################//	public function Notification_update($user_id,$status)	{		$update_sql= "UPDATE user_master SET notification ='$status' WHERE id='$user_id'";		$update_result = $this->db->query($update_sql);				$response = array("status" => "Success", "msg" => "Notification Updated");		return $response;	}//#################### Notification update End ####################////#################### News Feed Categories ####################//	public function Newsfeeds_category($user_id)	{			$query = "SELECT * FROM nf_category WHERE status = 'Active'";			$resultset = $this->db->query($query);			$category_result = $resultset->result();			if($resultset->num_rows()>0) {					$response = array("status" => "Success", "msg" => "List All Category", "category_result" =>$category_result);			} else {					$response = array("status" => "Error", "msg" => "No records found");			}				return $response;	}//#################### All News Feed End ####################////#################### All News Feed ####################//	public function All_newsfeeds($offset,$rowcount)	{			$news_count = "SELECT * FROM news_feed WHERE status = 'Active'";			$news_count_res = $this->db->query($news_count);			$news_count = $news_count_res->num_rows();						$query = "SELECT * FROM news_feed WHERE status = 'Active' ORDER BY id DESC LIMIT $offset, $rowcount";			$resultset = $this->db->query($query);			$news_result = $resultset->result();			if($resultset->num_rows()>0) {					$response = array("status" => "Success", "msg" => "List All News", "nf_count" =>$news_count, "nf_result" =>$news_result);			} else {					$response = array("status" => "Error", "msg" => "No records found");			}				return $response;	}//#################### All News Feed End ####################////#################### All News ####################//	public function All_news($offset,$rowcount)	{			$news_count = "SELECT * FROM news_feed WHERE status = 'Active' AND (nf_category_id ='1' OR nf_category_id = '2')";			$news_count_res = $this->db->query($news_count);			$news_count = $news_count_res->num_rows();						$query = "SELECT * FROM news_feed WHERE status = 'Active' AND (nf_category_id ='1' OR nf_category_id = '2') ORDER BY id DESC LIMIT $offset, $rowcount";			$resultset = $this->db->query($query);			$news_result = $resultset->result();			if($resultset->num_rows()>0) {					$response = array("status" => "Success", "msg" => "List All News", "nf_count" =>$news_count, "nf_result" =>$news_result);			} else {					$response = array("status" => "Error", "msg" => "No records found");			}				return $response;	}//#################### All News End ####################////#################### All Events ####################//	public function All_events($offset,$rowcount)	{			$news_count = "SELECT * FROM news_feed WHERE status = 'Active' AND (nf_category_id ='3' OR nf_category_id = '4')";			$news_count_res = $this->db->query($news_count);			$news_count = $news_count_res->num_rows();						$query = "SELECT * FROM news_feed WHERE status = 'Active' AND (nf_category_id ='3' OR nf_category_id = '4') ORDER BY id DESC LIMIT $offset, $rowcount";			$resultset = $this->db->query($query);			$news_result = $resultset->result();			if($resultset->num_rows()>0) {					$response = array("status" => "Success", "msg" => "List All Events", "nf_count" =>$news_count, "nf_result" =>$news_result);			} else {					$response = array("status" => "Error", "msg" => "No records found");			}				return $response;	}//#################### All Events End ####################////#################### News feed by category ####################//	public function Newsfeeds_categoryid($nf_category_id,$offset,$rowcount)	{			$news_count = "SELECT * FROM news_feed WHERE nf_category_id ='$nf_category_id' AND status = 'Active'";			$news_count_res = $this->db->query($news_count);			$news_count = $news_count_res->num_rows();						$query = "SELECT * FROM news_feed WHERE nf_category_id ='$nf_category_id'  AND status = 'Active' ORDER BY id DESC LIMIT $offset, $rowcount";			$resultset = $this->db->query($query);			$news_result = $resultset->result();			if($resultset->num_rows()>0) {					$response = array("status" => "Success", "msg" => "List News by category", "nf_count" =>$news_count, "nf_result" =>$news_result);			} else {					$response = array("status" => "Error", "msg" => "No records found");			}				return $response;	}//#################### News feed by category End ####################////#################### News Details ####################//	public function Newsfeed_details($newsfeed_id)	{			$update_sql = "UPDATE news_feed SET view_count = view_count+1 WHERE id  ='$newsfeed_id'";    		$update_view_count = $this->db->query($update_sql);						$query = "SELECT * FROM news_feed WHERE id = $newsfeed_id";			$resultset = $this->db->query($query);			$news_result = $resultset->result();			$img_query = "SELECT * FROM nf_image_gallery WHERE nf_id = '$newsfeed_id' ";			$img_res = $this->db->query($img_query);			$image_count = $img_res->num_rows();			$image_result = $img_res->result();						$response = array("status" => "Success", "msg" => "News Details", "news_result" =>$news_result, "image_count" =>$image_count, "image_result" =>$image_result);							return $response;	}//#################### News Details End ####################////#################### News Details ####################//	public function Share_count($newsfeed_id)	{			$update_sql = "UPDATE news_feed SET share_count = share_count+1 WHERE id  ='$newsfeed_id'";    		$update_share_count = $this->db->query($update_sql);			$response = array("status" => "Success", "msg" => "Share_count Updated");		return $response;	}//#################### News Details End ####################////#################### Enquiry Details ####################//	public function Enquiry_update($user_id,$enq_details)	{			$sQuery = "INSERT INTO spv_chat (chat_for,chat_text,admin_seen,user_seen,chat_by,chat_user_id,created_at) VALUES ('".$user_id. "','".$enq_details. "','0','1','User','$user_id',now())";			$insert_enq = $this->db->query($sQuery);			$enq_id = $this->db->insert_id();			$response = array("status" => "Success", "msg" => "Enquiry Added","enq_id" => $enq_id,);		return $response;	}//#################### Enquiry Details End ####################////#################### Enquiry attachment ####################//	public function Enquiry_attachment($enq_id,$enqFileName,$temp)	{			$sQuery = "INSERT INTO spv_chat_document (chat_id,file_name,file_ext,created_at) VALUES ('".$enq_id. "','".$enqFileName. "','$temp',now())";			$insert_enq = $this->db->query($sQuery);			$response = array("status" => "Success", "msg" => "Enquiry Attchemnt Added","enq_id" => $enq_id,);		return $response;	}//#################### Enquiry attachment End ####################////#################### Enquiry history ####################//	public function Enquiry_history($user_id)	{		$userQuery = "SELECT * FROM spv_chat WHERE chat_for ='$user_id'";		$user_result = $this->db->query($userQuery);		if($user_result->num_rows()>0)		{			foreach ($user_result->result() as $rows)			{				$chat_id = $rows->id;				$chat_text  = $rows->chat_text ;				$attachment_flag = $rows->attachment_flag;				$chat_by = $rows->chat_by;				$chat_user_id = $rows->chat_user_id;				$created_at = $rows->created_at;								if ($chat_by == 'Admin'){					 $sQuery = "SELECT full_name FROM admin_user_master WHERE id ='$chat_user_id'";				} else {					$sQuery = "SELECT full_name FROM user_master WHERE id ='$chat_user_id'";				}					$sResult = $this->db->query($sQuery);						if($sResult->num_rows()>0)						{							foreach ($sResult->result() as $sRows)							{								$posted_by = $sRows->full_name;							}						}											if ($attachment_flag ==1){								$query = "SELECT * FROM spv_chat_document WHERE chat_id = '$chat_id'";								$resultset = $this->db->query($query);								$attach_result = $resultset->result();						} else {								$attach_result = "Nill";						}										$chatData[]  = array(						"chat_id" => $chat_id,						"posted_by" => $posted_by,						"chat_text" => $chat_text,												"created_at" => $created_at,						"attachment_flag" => $attachment_flag,						"attchments" => $attach_result					);			}							$update_sql = "UPDATE spv_chat SET user_seen = '1' WHERE chat_for ='$user_id'";    		$update_share_count = $this->db->query($update_sql);							$response = array("status" => "Success", "msg" => "Enquiry Details", "enquiry_result" =>$chatData);		} else {			$response = array("status" => "Error", "msg" => "No Records Found.",);		}										return $response;	}//#################### Enquiry_history End ####################////#################### Personal Details ####################//	public function Spv_personal($user_id)	{			$query = "SELECT * FROM spv_personal_life WHERE id = '1'";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Personal Details", "personal_result" =>$result);							return $response;	}//#################### Personal Details End ####################////#################### Political Details ####################//	public function Spv_political($user_id)	{			$query = "SELECT * FROM spv_political_career WHERE id = '1'";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Political Details", "political_result" =>$result);							return $response;	}//#################### Political Details End ####################////#################### Position Details ####################//	public function Spv_positionheld($user_id)	{			$query = "SELECT * FROM spv_position_held WHERE status = 'Active' ORDER BY id DESC";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Position Details", "position_result" =>$result);							return $response;	}//#################### Position Details End ####################////#################### Award Details ####################//	public function Spv_awards($user_id)	{			$dquery = "SELECT awards_text_ta AS page_title_ta,awards_text_en AS page_title_en FROM spv_awards_description WHERE id = '1'";			$dresultset = $this->db->query($dquery);			$dresult = $dresultset->result();						$query = "SELECT * FROM spv_awards WHERE status = 'Active' ORDER BY id DESC";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Award Details","award_page_heading" =>$dresult, "award_result" =>$result);							return $response;	}//#################### Award Details End ####################////#################### Notable Details ####################//	public function Spv_notable($user_id)	{			$query = "SELECT * FROM spv_noteable_works WHERE status = 'Active' ORDER BY id DESC";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Position Details", "position_result" =>$result);							return $response;	}//#################### Notable Details End ####################////#################### Namakkaga Details ####################//	public function Spv_namakkaga($user_id)	{			$query = "SELECT * FROM spv_namakkaga_initiatives WHERE id = '1'";			$resultset = $this->db->query($query);			$result = $resultset->result();					$response = array("status" => "Success", "msg" => "Position Details", "position_result" =>$result);							return $response;	}//#################### Namakkaga Details End ####################////#################### Academy Details ####################//	public function Spv_ias_academy($user_id)	{			$query = "SELECT * FROM amma_ias_academy WHERE id = '1'";			$resultset = $this->db->query($query);			$result = $resultset->result();						$cquery = "SELECT * FROM amma_ias_academy_course WHERE status = 'Active' ORDER BY id DESC";			$cresultset = $this->db->query($cquery);			$cresult = $cresultset->result();					$response = array("status" => "Success", "msg" => "Academy Details", "academy_result" =>$result, "course_result" =>$cresult);							return $response;	}//#################### Academy Details End ####################////#################### Social media Details ####################//	public function Spv_socialmedia($user_id)	{			$query = "SELECT * FROM social_media WHERE sm_url != ''";			$resultset = $this->db->query($query);			$result = $resultset->result();					if($resultset->num_rows()>0) {				$response = array("status" => "Success", "msg" => "Social Media Details", "socialmedia_result" =>$result);			} else {				$response = array("status" => "Error", "msg" => "No records found!");			}							return $response;	}//#################### Social media Details End ####################////#################### About Party Details ####################//	public function About_party($user_id)	{			$query = "SELECT * FROM about_party WHERE id = '1'";			$resultset = $this->db->query($query);			$result = $resultset->result();					if($resultset->num_rows()>0) {				$response = array("status" => "Success", "msg" => "Party Details", "party_result" =>$result);			} else {				$response = array("status" => "Error", "msg" => "No records found!");			}							return $response;	}//#################### About Party Details End ####################////#################### About Party Details ####################//	public function Party_elections($user_id)	{			$bquery = "SELECT party_banner FROM about_party WHERE id = '1'";			$bresultset = $this->db->query($bquery);			$bresult = $bresultset->result();						$query = "SELECT * FROM party_election_info WHERE status = 'Active'";			$resultset = $this->db->query($query);			$result = $resultset->result();					if($resultset->num_rows()>0) {				$response = array("status" => "Success", "msg" => "Party Election Details","banner_image" =>$bresult, "election_result" =>$result);			} else {				$response = array("status" => "Error", "msg" => "No records found!");			}							return $response;	}//#################### About Party Details End ####################//
}
?>
